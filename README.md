# BowlingCPU

浙江大学《计算机组成》课程实验（2023-2024 学年春夏学期），基于 RISC-V 32I 的简单 CPU 实现。硬件描述语言为 Verilog。

完成内容如下：

- Lab4：单周期 CPU，RV32I 所有指令，异常与中断
- Lab5：流水线 CPU

注意：内部信号和部分接口经自行设计，与实验指导略有不同。

- ALU 控制信号：

| ALUControl |      |
| ---------- | ---- |
| and        | 0000 |
| or         | 0001 |
| add        | 0010 |
| xor        | 0011 |
| sll        | 0100 |
| srl        | 0101 |
| sub        | 0110 |
| slt        | 0111 |
| sra        | 1000 |
| sltu       | 1001 |
| no         | 1111 |

- MemToReg 控制信号：

| MemtoReg |        |
| -------- | ------ |
| 00       | ALU    |
| 01       | Mem    |
| 10       | PC+4   |
| 11       | imm    |
|          | PC+imm |

- 控制单元（所有指令+异常中断）：

| inst    | FMT  | OPCode  | func3 | func12        | ALUOp | ALUControl | ALUSrc_B | branch | branchZero | jump | Memread | MemToReg | Memwrite | RegWrite | ill_inst | mret | ecall | RegIn     | identifier                    | Control_signal           | Statement                                                    |
| ------- | ---- | ------- | ----- | ------------- | ----- | ---------- | -------- | ------ | ---------- | ---- | ------- | -------- | -------- | -------- | -------- | ---- | ----- | --------- | ----------------------------- | ------------------------ | ------------------------------------------------------------ |
| add     | R    | 0110011 | 000   | 0000000_????? | add   | 0010       | 0        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0110011_000_0000000_????? | 17'b00100_0000_00001_000 | 22'b0110011_000_0000000_?????: `CONTROL =  17'b00100_0000_00001_000; //add |
| sub     | R    | 0110011 | 000   | 0100000_????? | sub   | 0110       | 0        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0110011_000_0100000_????? | 17'b01100_0000_00001_000 | 22'b0110011_000_0100000_?????: `CONTROL =  17'b01100_0000_00001_000; //sub |
| xor     | R    | 0110011 | 100   | 0000000_????? | xor   | 0011       | 0        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0110011_100_0000000_????? | 17'b00110_0000_00001_000 | 22'b0110011_100_0000000_?????: `CONTROL =  17'b00110_0000_00001_000; //xor |
| or      | R    | 0110011 | 110   | 0000000_????? | or    | 0001       | 0        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0110011_110_0000000_????? | 17'b00010_0000_00001_000 | 22'b0110011_110_0000000_?????: `CONTROL =  17'b00010_0000_00001_000; //or |
| and     | R    | 0110011 | 111   | 0000000_????? | and   | 0000       | 0        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0110011_111_0000000_????? | 17'b00000_0000_00001_000 | 22'b0110011_111_0000000_?????: `CONTROL =  17'b00000_0000_00001_000; //and |
| sll     | R    | 0110011 | 001   | 0000000_????? | sll   | 0100       | 0        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0110011_001_0000000_????? | 17'b01000_0000_00001_000 | 22'b0110011_001_0000000_?????: `CONTROL =  17'b01000_0000_00001_000; //sll |
| srl     | R    | 0110011 | 101   | 0000000_????? | srl   | 0101       | 0        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0110011_101_0000000_????? | 17'b01010_0000_00001_000 | 22'b0110011_101_0000000_?????: `CONTROL =  17'b01010_0000_00001_000; //srl |
| sra     | R    | 0110011 | 101   | 0100000_????? | sra   | 1000       | 0        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0110011_101_0100000_????? | 17'b10000_0000_00001_000 | 22'b0110011_101_0100000_?????: `CONTROL =  17'b10000_0000_00001_000; //sra |
| slt     | R    | 0110011 | 010   | 0000000_????? | slt   | 0111       | 0        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0110011_010_0000000_????? | 17'b01110_0000_00001_000 | 22'b0110011_010_0000000_?????: `CONTROL =  17'b01110_0000_00001_000; //slt |
| sltu    | R    | 0110011 | 011   | 0000000_????? | sltu  | 1001       | 0        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0110011_011_0000000_????? | 17'b10010_0000_00001_000 | 22'b0110011_011_0000000_?????: `CONTROL =  17'b10010_0000_00001_000; //sltu |
| addi    | I    | 0010011 | 000   | ???????_????? | add   | 0010       | 1        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0010011_000_???????_????? | 17'b00101_0000_00001_000 | 22'b0010011_000_???????_?????: `CONTROL =  17'b00101_0000_00001_000; //addi |
| xori    | I    | 0010011 | 100   | ???????_????? | xor   | 0011       | 1        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0010011_100_???????_????? | 17'b00111_0000_00001_000 | 22'b0010011_100_???????_?????: `CONTROL =  17'b00111_0000_00001_000; //xori |
| ori     | I    | 0010011 | 110   | ???????_????? | or    | 0001       | 1        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0010011_110_???????_????? | 17'b00011_0000_00001_000 | 22'b0010011_110_???????_?????: `CONTROL =  17'b00011_0000_00001_000; //ori |
| andi    | I    | 0010011 | 111   | ???????_????? | and   | 0000       | 1        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0010011_111_???????_????? | 17'b00001_0000_00001_000 | 22'b0010011_111_???????_?????: `CONTROL =  17'b00001_0000_00001_000; //andi |
| slli    | I    | 0010011 | 001   | 0000000_????? | sll   | 0100       | 1        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0010011_001_0000000_????? | 17'b01001_0000_00001_000 | 22'b0010011_001_0000000_?????: `CONTROL =  17'b01001_0000_00001_000; //slli |
| srli    | I    | 0010011 | 101   | 0000000_????? | srl   | 0101       | 1        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0010011_101_0000000_????? | 17'b01011_0000_00001_000 | 22'b0010011_101_0000000_?????: `CONTROL =  17'b01011_0000_00001_000; //srli |
| srai    | I    | 0010011 | 101   | 0100000_????? | sra   | 1000       | 1        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0010011_101_0100000_????? | 17'b10001_0000_00001_000 | 22'b0010011_101_0100000_?????: `CONTROL =  17'b10001_0000_00001_000; //srai |
| slti    | I    | 0010011 | 010   | ???????_????? | slt   | 0111       | 1        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0010011_010_???????_????? | 17'b01111_0000_00001_000 | 22'b0010011_010_???????_?????: `CONTROL =  17'b01111_0000_00001_000; //slti |
| sltiu   | I    | 0010011 | 011   | ???????_????? | sltu  | 1001       | 1        | 0      | 0          | 00   | 0       | 00       | 0        | 1        | 0        | 0    | 0     |           | 22'b0010011_011_???????_????? | 17'b10011_0000_00001_000 | 22'b0010011_011_???????_?????: `CONTROL =  17'b10011_0000_00001_000; //sltiu |
| lb      | I    | 0000011 | 000   | ???????_????? | add   | 0010       | 1        | 0      | 0          | 00   | 1       | 01       | 0        | 1        | 0        | 0    | 0     |           | 22'b0000011_000_???????_????? | 17'b00101_0000_10101_000 | 22'b0000011_000_???????_?????: `CONTROL =  17'b00101_0000_10101_000; //lb |
| lh      | I    | 0000011 | 001   | ???????_????? | add   | 0010       | 1        | 0      | 0          | 00   | 1       | 01       | 0        | 1        | 0        | 0    | 0     |           | 22'b0000011_001_???????_????? | 17'b00101_0000_10101_000 | 22'b0000011_001_???????_?????: `CONTROL =  17'b00101_0000_10101_000; //lh |
| lw      | I    | 0000011 | 010   | ???????_????? | add   | 0010       | 1        | 0      | 0          | 00   | 1       | 01       | 0        | 1        | 0        | 0    | 0     |           | 22'b0000011_010_???????_????? | 17'b00101_0000_10101_000 | 22'b0000011_010_???????_?????: `CONTROL =  17'b00101_0000_10101_000; //lw |
| lbu     | I    | 0000011 | 100   | ???????_????? | add   | 0010       | 1        | 0      | 0          | 00   | 1       | 01       | 0        | 1        | 0        | 0    | 0     |           | 22'b0000011_100_???????_????? | 17'b00101_0000_10101_000 | 22'b0000011_100_???????_?????: `CONTROL =  17'b00101_0000_10101_000; //lbu |
| lhu     | I    | 0000011 | 101   | ???????_????? | add   | 0010       | 1        | 0      | 0          | 00   | 1       | 01       | 0        | 1        | 0        | 0    | 0     |           | 22'b0000011_101_???????_????? | 17'b00101_0000_10101_000 | 22'b0000011_101_???????_?????: `CONTROL =  17'b00101_0000_10101_000; //lhu |
| sb      | S    | 0100011 | 000   | ???????_????? | add   | 0010       | 1        | 0      | 0          | 00   | 0       | 00       | 1        | 0        | 0        | 0    | 0     |           | 22'b0100011_000_???????_????? | 17'b00101_0000_00010_000 | 22'b0100011_000_???????_?????: `CONTROL =  17'b00101_0000_00010_000; //sb |
| sh      | S    | 0100011 | 001   | ???????_????? | add   | 0010       | 1        | 0      | 0          | 00   | 0       | 00       | 1        | 0        | 0        | 0    | 0     |           | 22'b0100011_001_???????_????? | 17'b00101_0000_00010_000 | 22'b0100011_001_???????_?????: `CONTROL =  17'b00101_0000_00010_000; //sh |
| sw      | S    | 0100011 | 010   | ???????_????? | add   | 0010       | 1        | 0      | 0          | 00   | 0       | 00       | 1        | 0        | 0        | 0    | 0     |           | 22'b0100011_010_???????_????? | 17'b00101_0000_00010_000 | 22'b0100011_010_???????_?????: `CONTROL =  17'b00101_0000_00010_000; //sw |
| beq     | B    | 1100011 | 000   | ???????_????? | sub   | 0110       | 0        | 1      | 1          | 00   | 0       | 00       | 0        | 0        | 0        | 0    | 0     |           | 22'b1100011_000_???????_????? | 17'b01100_1100_00000_000 | 22'b1100011_000_???????_?????: `CONTROL =  17'b01100_1100_00000_000; //beq |
| bne     | B    | 1100011 | 001   | ???????_????? | sub   | 0110       | 0        | 1      | 0          | 00   | 0       | 00       | 0        | 0        | 0        | 0    | 0     |           | 22'b1100011_001_???????_????? | 17'b01100_1000_00000_000 | 22'b1100011_001_???????_?????: `CONTROL =  17'b01100_1000_00000_000; //bne |
| blt     | B    | 1100011 | 100   | ???????_????? | slt   | 0111       | 0        | 1      | 0          | 00   | 0       | 00       | 0        | 0        | 0        | 0    | 0     |           | 22'b1100011_100_???????_????? | 17'b01110_1000_00000_000 | 22'b1100011_100_???????_?????: `CONTROL =  17'b01110_1000_00000_000; //blt |
| bge     | B    | 1100011 | 101   | ???????_????? | slt   | 0111       | 0        | 1      | 1          | 00   | 0       | 00       | 0        | 0        | 0        | 0    | 0     |           | 22'b1100011_101_???????_????? | 17'b01110_1100_00000_000 | 22'b1100011_101_???????_?????: `CONTROL =  17'b01110_1100_00000_000; //bge |
| bltu    | B    | 1100011 | 110   | ???????_????? | sltu  | 1001       | 0        | 1      | 0          | 00   | 0       | 00       | 0        | 0        | 0        | 0    | 0     |           | 22'b1100011_110_???????_????? | 17'b10010_1000_00000_000 | 22'b1100011_110_???????_?????: `CONTROL =  17'b10010_1000_00000_000; //bltu |
| bgeu    | B    | 1100011 | 111   | ???????_????? | sltu  | 1001       | 0        | 1      | 1          | 00   | 0       | 00       | 0        | 0        | 0        | 0    | 0     |           | 22'b1100011_111_???????_????? | 17'b10010_1100_00000_000 | 22'b1100011_111_???????_?????: `CONTROL =  17'b10010_1100_00000_000; //bgeu |
| jal     | J    | 1101111 | ???   | ???????_????? | no    | 1111       | 0        | 0      | 0          | 01   | 0       | 10       | 0        | 1        | 0        | 0    | 0     | PC+4      | 22'b1101111_???_???????_????? | 17'b11110_0001_01001_000 | 22'b1101111_???_???????_?????: `CONTROL =  17'b11110_0001_01001_000; //jal |
| jalr    | I    | 1100111 | 000   | ???????_????? | no    | 1111       | 0        | 0      | 0          | 10   | 0       | 10       | 0        | 1        | 0        | 0    | 0     | PC+4      | 22'b1100111_000_???????_????? | 17'b11110_0010_01001_000 | 22'b1100111_000_???????_?????: `CONTROL =  17'b11110_0010_01001_000; //jalr |
| lui     | U    | 0110111 | ???   | ???????_????? | no    | 1111       | 0        | 0      | 0          | 00   | 1       | 11       | 0        | 1        | 0        | 0    | 0     | ImmGen    | 22'b0110111_???_???????_????? | 17'b11110_0000_11101_000 | 22'b0110111_???_???????_?????: `CONTROL =  17'b11110_0000_11101_000; //lui |
| auipc   | U    | 0010111 | ???   | ???????_????? | no    | 1111       | 0        | 0      | 0          | 00   | 0       | 11       | 0        | 1        | 0        | 0    | 0     | PC+ImmGen | 22'b0010111_???_???????_????? | 17'b11110_0000_01101_000 | 22'b0010111_???_???????_?????: `CONTROL =  17'b11110_0000_01101_000; //auipc |
| ecall   | I    | 1110011 | 000   | 0000000_00000 | no    | 1111       | 0        | 0      | 0          | 00   | 0       | 00       | 0        | 0        | 0        | 0    | 1     |           | 22'b1110011_000_0000000_00000 | 17'b11110_0000_00000_001 | 22'b1110011_000_0000000_00000: `CONTROL =  17'b11110_0000_00000_001; //ecall |
| ebreak  | I    | 1110011 | 000   | 0000000_00001 | no    | 1111       | 0        | 0      | 0          | 00   | 0       | 00       | 0        | 0        | 0        | 0    | 1     |           | 22'b1110011_000_0000000_00001 | 17'b11110_0000_00000_001 | 22'b1110011_000_0000000_00001: `CONTROL =  17'b11110_0000_00000_001; //ebreak |
| mret    | I    | 1110011 | 000   | 0011000_00010 | no    | 1111       | 0        | 0      | 0          | 00   | 0       | 00       | 0        | 0        | 0        | 1    | 0     |           | 22'b1110011_000_0011000_00010 | 17'b11110_0000_00000_010 | 22'b1110011_000_0011000_00010: `CONTROL =  17'b11110_0000_00000_010; //mret |
| ILLEGAL |      |         |       |               | no    | 1111       | 0        | 0      | 0          | 00   | 0       | 00       | 0        | 0        | 1        | 0    | 0     |           | default                       | 17'b11110_0000_00000_100 | default: `CONTROL = 17'b11110_0000_00000_100; //ILLEGAL      |

- 跳转控制：

|            | PC                 | Branch | BranchZero | Zero | Jump |                                         |
| ---------- | ------------------ | ------ | ---------- | ---- | ---- | --------------------------------------- |
| branchfail |                    | 0      | ?          | ?    | 00   | 5'b0??00: PC_out <= ;                   |
| branchfail |                    | 1      | 1          | 0    | 00   | 5'b11000: PC_out <= ;                   |
| normal     | PC_out + 4         | 1      | 0          | 1    | 00   | 5'b10100: PC_out <= PC_out + 4;         |
| branch     |                    | 1      | 1          | 1    | 00   | 5'b11100: PC_out <= ;                   |
| branch     |                    | 1      | 0          | 0    | 00   | 5'b10000: PC_out <= ;                   |
| jal        | PC_out + Imm_out   | 0      | 0          | ?    | 01   | 5'b00?01: PC_out <= PC_out + Imm_out;   |
| jalr       | Rs1_data + Imm_out | 0      | 0          | ?    | 10   | 5'b00?10: PC_out <= Rs1_data + Imm_out; |

- 异常中断：

|           | PC                                  | MODE | interrupt | ecall | ill_inst | mret |                                                           |
| --------- | ----------------------------------- | ---- | --------- | ----- | -------- | ---- | --------------------------------------------------------- |
| ecall     |                                     | 0    | 0         | 1     | 0        | 0    | 5'b00100: PC_out <= ;                                     |
| ill_inst  | {mtvec[31:1], 1'b0}                 | 0    | 0         | 0     | 1        | 0    | 5'b00010: PC_out <= {mtvec[31:1], 1'b0};                  |
| interrupt | {mtvec[31:1], 1'b0} + (mcause << 2) | 1    | 1         | 0     | 0        | 0    | 5'b11000: PC_out <= {mtvec[31:1], 1'b0} + (mcause <<  2); |
| mret      | mepc                                | ?    | 0         | 0     | 0        | 1    | 5'b?0001: PC_out <= mepc;                                 |
| default   |                                     | ?    | ?         | ?     | ?        | ?    |                                                           |

|           | mcause   | mtval | mepc |
| --------- | -------- | ----- | ---- |
| ill_inst  | 0000000B | inst  | PC   |
| ecall     | 00000002 | addr  | PC   |
| interrupt | 80000000 | addr  | PC   |
| rst       | 0        |       | 0    |